





## 网络层

*七层模型*
- 物理层 定义物理设备如何传输数据 0 1 
- 数据链路层 实体间创建数据链路连接
- 网络层 地址管理 路由选择 ip
- 传输层  两个节点间的数据传输 tcp udp
- 会话层 通信管理，负责建立和断开通信连接
- 表示层 设备固有数据格式和网络标准数据格式的转换
- 应用层 对特定应用的协议：电子邮件->电子邮件协议，远程登陆，文件传输等

*五层模型*
- 应用层 http ftp telnet smtp websocket
- 传输层 tcp udp
- 网络层
      - Internet 协议 IP
      - Internet 控制信息协议 ICMP
      - 地址解析协议 ARP
      - 反向地址解析协议 RARP
- 数据链路层
- 物理层



## tcp/udp


### TCP
传输控制协议（TCP，Transmission Control Protocol）是一种面向连接的、可靠的、基于字节流的传输层通信协议，由 IETF 的 RFC 793 定义。

基于流的方式
面向连接
丢包重传
保证数据顺序


### UDP
Internet 协议集支持一个无连接的传输协议，该协议称为用户数据报协议（UDP，User Datagram Protocol）。UDP 为应用程序提供了一种无需建立连接就可以发送封装的 IP 数据包的方法。RFC 768 描述了 UDP。

UDP 是非连接的协议，也就是不会跟终端建立连接
UDP 包信息只有 8 个字节
UDP 是面向报文的。既不拆分，也不合并，而是保留这些报文的边界
UDP 可能丢包
UDP 不保证数据顺序


## 三次握手与四次挥手

### 三次握手

三次握手就是建立一个 TCP 链接时，双方需要总共发送3个包  
主要作用是确认双方的接收和发送能力是否正常,指定自己的初始化序列号为后面的可靠性传输做准备 
主要步骤:
1. 客户端发起, 发送 同步序列号(syn),并指明客户端的初始序列号ISN seq=x
2. 服务端接收, 开启一个socket端口, 发送一个新的syn包和确认字符ack=y=x+1，表示发送和接收能力是正常的
3. 客户端发起，向服务器发送ack=y+1包，客户端和服务端进入 established(tcp连接成功)状态

问题:
1. 为什么需要三次: 防止失效的请求报文段被服务器接受，而导致错误 
2. ISN 初始化序列号，动态生成的，随时间变化
3. 前两次不可携带数据，第三次可以: 为了防止syn中携带过多信息而被攻击

#### 半连接队列

服务器第一次收到syn后, 会处于syn_received状态，双方没有完全建立连接，服务器会把这种状态的请求连接放在一个队列里 


#### SYN攻击 

服务器端的资源分配是在二次握手时分配的，而客户端的资源是在完成三次握手时分配的 
客户端在短时间内伪造大量不存在的IP地址, 向server不断地发送syn,Server则回复确认包，并等待Client确认，由于源地址不存在，因此Server需要不断重发直至超时，这些伪造的SYN包将长时间占用未连接队列，导致正常的SYN请求因为队列满而被丢弃，从而引起网络拥塞甚至系统瘫痪。SYN 攻击是一种典型的 DoS/DDoS 攻击。

常见防御方式:
1. 缩短 syn timeout
2. 增加最大半连接数
3. 过滤网关防护


### 四次挥手

主要步骤
1. 客户端发送一个 FIN 报文，进入等待状态, 表示已经没有数据要发送了
2. 服务端收到 FIN ,回一个 ACK 确认报文,表示已收到
3. 服务端发送 FIN , 请求关闭连接， 表示数据都已接收完
4. 客户端发送 ACK，并进入等待, 服务端收到后 关闭连接, 客户端在 2MSL 后自动关闭  


问题:
1. 2MSL 两个最大段生命周期
  - 保证客户端发送的最后一个ACK报文段能够到达服务端
  - 防止“已失效的连接请求报文段”出现在本连接中


## http1.1

相对于http1.0的改进和优化:
- 持久连接
- 管道化请求
- 分块编码传送
- 新增host头字段
- 缓存支持
- 更多状态码

### 持久连接

可以在一次 TCP 连接中发送和接收多个 HTTP 请求/响应


### 管道化请求

HTTP 管道化是指将多个 HTTP 请求同时发送给服务器的技术，但是响应必须按照请求发出的顺序依次返回 

问题:
1. 前面的响应慢会阻塞后面的
2. 服务器为了保证能按序返回需要缓存提前完成的响应而占用更多资源

### 分块编码传送

在 HTTP/1.1 协议里，允许在响应头中指定 Transfer-Encoding: chunked 标识当前为分块编码传输，可以将内容实体分装成一个个块进行传输。  
好处：
1. 允许服务器为动态生成的内容维持HTTP持久链接
2. HTTP服务器有时使用压缩（gzip）以缩短传输花费的时间，边压缩边传

### 滑动窗口

实现TCP传输可靠性的一种手段 

发送方的发送窗口时不能大于接收方的接收窗口的。 以字节为单位的滑动窗口技术，可以很好的协调双方的收发能力

### http1.1 缺点

1. http队头阻塞: 管道化 接受响应是按顺序的，如果面试的没完成 后面的就会被阻塞
2. 头部冗余
3. tcp连接数限制



## http2

主要是为了解决1.1的 队头阻塞问题，优化速度

  - 多路复用  允许在单个 TCP 连接上并行地处理多个请求和响应
  - 二进制分帧
    - 二进制: 原本是文本协议 更换为二进制 使内容更加紧凑
    - 帧: 没帧除了信息还有个头部 包含当前的编号
  - 数据流
  - 头部压缩
    - 使用 HPACK 算法来压缩头部内容，包体积缩小，在网络上传输变快。
    - 发送差异数据，而不是全部发送，从而减少头部的信息量
  - server push
  - 问题：
    - tcp队头阻塞 丢包请求会等待重传 阻塞后面
    - 握手需要时间


### tcp 队头阻塞

一个TCP分节丢失，导致其后续分节不按序到达接收端的时候  
丢包请求会等待重传 阻塞后面

## http3

http3 基于UDP 实现 QUIC
  - 多路复用
  - 数据可靠
  - 快速握手
  - TLS 加密





### https 何如保证安全的

同时使用 对称加密 和 非对称加密: 
将对称加密的密钥使用非对称加密的公钥进行加密， 然后发送出去， 接收方使用私钥进行解密得到对称加密的密钥  
需要一中间人 把双方通信互发的公钥 换成自己的

第三方颁发的 CA 证书: 签发者， 证书用途， 使用者公钥， 使用者私钥， 使用者的hash算法， 证书到期时间

有关加密是在三次握手后进行的 

同时使用对称加密 非对称加密:
 1. 在证书认证阶段 非对称
 2. 数据传输阶段 对称加密

主要步骤:
客户端发起 -> 服务端返回证书
对证书进行验证,生成随机数作为对称加密的秘钥，使用证书中的公钥进行加密
服务端使用自己的私钥进行解密，后续的请求都是通过这个随机数进行的


相关问题:
1. 为什么需要CA机构: 保证证书的安全性， 防止 中间人攻击
2. 对称和非对称的好坏:  非对称安全， 对称性能高
3. 为什么安全: 采用数据加密的方式，防止传输过程被监听 数据被窃取
4. 为什么需要证书: 为网站提供身份证明， 防止中间人攻击
5. 会被抓包吗: 在用户主动授信的情况， 可以构建中间人网络，实现抓包

并非完全安全：
1. ssl剥离
2. 攻击dns伪造证书等 


#### ssl

一种网络攻击，阻止用户使用 HTTPS 访问网站，将 Web 连接从更安全的 HTTPS 降级到安全性较低的 HTTP

方法:
- 代理服务器
- arp欺骗
- 网络访问: 公共wifi

#### 证书的验证过程
1. 校验证书的有效期  域名是否有效
2. 校验颁发机构是否可信
3. 取颁发机构的公钥 对证书的签名进行解密
4. 用相同的算法对证书进行hash 与解密后的值比对
5. 

### http2 相对 http1.x 的优势和特点

*二进制分帧* 
http2 数据通信的最小单位是帧，指http2逻辑上的信息， 如 请求响应等， 消息由一个或多个帧组成 
http2 采用二进制格式传输数据， 解析起来更高效
http1 采用文本格式


*服务器推送*


*头部压缩*

2 只发送差异数据，而不是全部发送，从而减少头部的信息量


*多路复用*

2 同域名下所有通信都在单个连接伤完成
1 并发多个请求， 必须使用多个 TCP 连接



### post 编码格式

Content-Type: 
1. application/x-www-form-unlencoded
  提交的数据按照 key1=val1&key2=val2 的方式进行编码， key 和 val 都进行了url转码  默认编码方式
2. multipart/form-data
  常见的 post 数据提交方式， 
3. application/json
  消息主体是序列化的 json 字符串
4. text/xml
  xml  结构过于臃肿，




### 委托协议栈发送消息
1. 创建套接字
  - 浏览器，邮件等一般的应用程序收发数据时用 TCP
  - DNS 查询等收发较短的控制数据时用 UDP
2. 连接服务器
  > 浏览器调用 Socket.connect
  - 在 TCP 模块处创建表示连接控制信息的头部
  - 通过 TCP 头部中的发送方和接收方端口号找到要连接的套接字
3. 收发数据
  > 浏览器调用 Socket.write
4. 断开管道并删除套接字
  > 浏览器调用 Socket.close

#### TCP
传输控制协议（TCP，Transmission Control Protocol）是一种面向连接的、可靠的、基于字节流的传输层通信协议，由 IETF 的 RFC 793 定义。

基于流的方式
面向连接
丢包重传
保证数据顺序


#### UDP
Internet 协议集支持一个无连接的传输协议，该协议称为用户数据报协议（UDP，User Datagram Protocol）。UDP 为应用程序提供了一种无需建立连接就可以发送封装的 IP 数据包的方法。RFC 768 描述了 UDP。

UDP 是非连接的协议，也就是不会跟终端建立连接
UDP 包信息只有 8 个字节
UDP 是面向报文的。既不拆分，也不合并，而是保留这些报文的边界
UDP 可能丢包
UDP 不保证数据顺序


#### 页面渲染流程
1. 创建 dom tree
2. 创建 cssom tree
3. 生成 render tree
4. 分层 layout tree
5. 将图层转换为位图
6. 合成位图并显示在页面上


### v8 js 编译
1. 生成 AST 和 执行上下文
2. tokenize 词法分析
3. parse 语法分析
4. 生成字节码
5. 执行




### url到显示界面

dns域名解析，查找ip
tcp连接



*三次握手*
1. 客户端向服务器发送 syn包(同步序列编号)，seq=x等待服务器确认
2. 服务器收到syn包，开启一个socket端口 并发送一个新的syn包和ack=x+1(确认字符，确认收到syn包) seq=y
3. 客户端收到包，向服务器发送ack=y+1包， 客户端和服务端进入 established(tcp连接成功)状态  

两次握手就可以建立连接了，为啥要第三次呢？ 
因为防止失效的连接请求报文段被服务器端接收，从而导致错误。

*四次挥手*
1. 客户端发送fin报文，进入等待状态，表示客户端没有哦数据要发给服务端
2. 服务端收到fin报文，给客户端回一个ack报文
3. 服务端向客户端发送fin报文，请求关闭连接，同时进入last_ack状态
4. 客户端收到报文，发送ack报文，并进入等待状态， 服务端收到报文，关闭连接。客户端等待2MSL（最大报 文段生存时间）后依然没有收到回复，则说明服务端已正常关闭，这样客户端也可以关闭连接了


*web性能优化 关于http*
- DNS查询优化
- 客户端缓存
- 优化TCP连接
- 避免重定向
- 网络边缘的缓存
- 条件缓存
- 压缩和代码极简化
- 图片优化



*http1.1*
- 改进持久连接和CDN域名的分片机制
  - http后 tcp不关闭
- 不成熟的http管道化
- 提供虚拟主机支持
- 对动态生成的内容完美支持
- 引入cookie以及安全机制



*http1.1*
问题: 队头阻塞 
http1中要给特性为管道化，可以允许一次发送一组请求，但是需要按照发送顺序依次接收响应。所以在请求应答过程中，如发生什么情况，剩下的工作都会被阻塞，这就是“队头阻塞”（阻塞在那次请求应答发生错误），阻碍网络传输和web页面的渲染，指导失去响应。




*多个域名存储资源会更有效*
cdn缓存更方便
突破浏览器并发限制
节约cookie带宽
节约主域名连接数 优化响应速度
防止不必要的安全性问题



*网络层级*
- 物理层 定义物理设备如何传输数据 0 1 
- 数据链路层 实体间创建数据链路连接
- 网络层 地址管理 路由选择 ip
- 传输层  两个节点间的数据传输 tcp udp
- 会话层 通信管理，负责建立和断开通信连接
- 表示层 设备固有数据格式和网络标准数据格式的转换
- 应用层 对特定应用的协议：电子邮件->电子邮件协议，远程登陆，文件传输等


- 应用层 http ftp telnet smtp websocket
- 传输层 tcp udp
- 网络层
      - Internet 协议 IP
      - Internet 控制信息协议 ICMP
      - 地址解析协议 ARP
      - 反向地址解析协议 RARP
- 数据链路层
- 物理层


*http 主要特点*
- 简单快速
- 灵活
- 无连接
- 无状态




*token*
- 无状态 可扩展
- 安全性
- 多平台跨域
- 基于标准




http 0.9
  - 只有一个get
  - 没有header
  - 服务发送完毕， tcp连接关闭


URI 统一资源标示符 unitform resource identifer
  - URL 统一资源定位器  uniform resource locator
    - `protocol :// hostname[:port] / path / [;parameters][?query]#fragment`
    - 协议 主机 端口 路径 参数 查询 锚点
  - URN 永久统一资源定位符 
    - 资源移动后还可以被找到
    - 目前没有成熟的使用方案





http 客户端
  - broswer
  - curl (-v)




cors
  - 请求限制 不需要预请求的
    - get head post  
    - 允许content-type： text/plain multipart/form-data  application/x-www-form-ulrencoded
    - 
  
Access-Control-Allow-Origin
                    -Headers
                    -Maxage
                    -Methods


cache-control
  - public
  - private
  - no-cache    可以使用缓存 但是需要验证
  - no-store    永远不可使用缓存
  - max-age
  - s-masage 代理端存在
  - max-stale

last-modift etag



cookie
  - set-cookie



session


keepalive
  - Connection: keep-alive
  - Connection: close


数据协商
  - 请求
    - Accept
    - Accept-Encoding
    - Accept-Language
    - User-Agent
    - 
  - 响应
    - Content-Type
    - Content-Encoding
    - Content-Language
  

rewrite
  - 302 header -> location: 'new url'


csp
  - 限制资源获取
  - 报告资源获取越权

  - default-src http: https:
    - default-src
    - image-src
  - 资源类型
```
  // 只可以用外链 不能用标签
  'content-security-Policy: 'default-src http: https'
  // 指定本网站
  'content-security-Policy: 'default-src \'self\''
  'content-security-Policy-Report-Only': 'default-src \'self\''

```



IPv4 32位地址长度 8 * 4 * 2 - 1
IPv6 128位地址长度
除了更多的地址空间,还有性能上 安全性上的提高


### 简单请求

method： GET POST HEAD
header: 
  - text/plain
  - multipart/form-data
  - application/x-www-form-urlencoded






### 快速重传

超时重传存在问题，超时周期可能较长，通过超时时间来判断会增加端到端的延时  
通过检测 冗余的 ack 来判断是否需要重传， 3给冗余ack就说明已经丢失


### 流量控制 

避免接收方缓存溢出问题，
接收方维护一个接收窗口的变量来提供浏览控制 用来表示有多少可用的缓存空间 


### 拥塞控制
TCP 的发送发会因为 IP 网络拥塞而被遏制  资源需求(贷款 节点缓存等) > 可用资源

标志: 重传计时器超时或接收到三个重复确认  

避免: 慢启动 拥塞后就减小窗口大小





### 三次握手

- 其实就是指建立一个TCP连接时，需要客户端和服务器总共发送3个包。进行三次握手的主要作用就是为了确认双方的接收能力和发送能力是否正常、指定自己的初始化序列号为后面的可靠性传送做准备

1. 为什么三次
   为了防止已失效的请求发送到服务端引起错误

2. 半连接队列
  - 服务器在二次握手后， 处于等待状态， 会把这种状态下的请求连接放在一个队列中， 即 半连接队列
  - 

3.SYN的初始值 ISN 固定吗 序列号
  - ISN 发送方的字节数据编号的原点，让对方生成一个合法的接收窗口
  - 不固定 随时间变 增加安全性，为了避免被第三方猜测到，从而被第三方伪造的RST报文Reset。

4. syn 攻击
  - 伪造ip 多次发起握手



### 四次挥手
  1. 第一次挥手 客户端主动发起请求断开连接 FIN_WAIT1
  2. 服务端收到， 发出确认报文段 表明收到关闭请求  进入 CLOSE_WAIT
  3. 服务端所有内容发完后，发送连接请求关闭， 进入 LAST_ACK 最后确认
  4. 客户端收到后 发送确认 并进入TIME_WAIT  2MLS 后自动关闭


1. 为什么需要 2MSL 返回close状态
  防止“已失效的连接请求报文段”出现在本连接中， 2MSL 可以使所有报文段都消失
  1MSL 是一次报文传递的时间，2MSL可以保证目前没有报文在传递过程中



  ### https
  
 证书中包含了公钥 用途 颁发者 有效时间等 
其实也是一个非对称的加密过程   ca机构在签发证书时使用自己的私钥进行加密，  然后浏览器和操作系统中集成了 CA 的公钥信息 进行解密


## cdn

内容分发网络机制

### cdn 过程

  - dns解析
  - cdn网络专用DNS服务器 ip
  - 负责负载的系统服务器 ip
  - 匹配的 cdn设备 ip

### 回源

指 cdn 缓存服务器中没有符合客户端要求的资源时, 会请求上一级缓存服务器, 直接获取到